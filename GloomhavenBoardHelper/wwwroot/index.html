<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Virtual Gloomhaven Board</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.min.js"></script>
</head>
<body>
    <div id="elm-node"></div>
    <script>
        document.body.addEventListener("dragstart", event => {
            if (event.target && event.target.draggable) {
                // absurdly, this is needed for Firefox; see https://medium.com/elm-shorts/elm-drag-and-drop-game-630205556d2
                event.dataTransfer.setData("text/html", "blank");
                var emptyImage = document.createElement('img');
                // Set the src to be a 0x0 gif
                emptyImage.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';
                event.dataTransfer.setDragImage(emptyImage, 0, 0);
            }
        });

        document.body.addEventListener("dragover", event => {
            // this is needed in order to make dragging work
            return false;
        });

        const app = Elm.Main.init({
            node: document.getElementById("elm-node"),
            flags: Math.floor(Math.random() * Math.floor(4000))
        });

        const signalSocket = new WebSocket('ws://' + location.host + '/ws');
        let offerTimeout = null;

        /** SERVER IMPLEMENTATION **/
        // Create a server - register a client code/request a new one
        // Return the client code to Elm
        // When a client connects, notify Elm
        // Elm puhes the current state to the new client - updates the client list
        // When pushing a new client state, Elm should push to all clients

        /** CLIENT IMPLEMENTATION **/
        // Create a client - check client code
        // Return a connected/disconnected state
        // Elm pushes the current state to the server



        app.ports.pushGameStatePort.subscribe(function(message) {
            console.log(message);
            signalSocket.send("UPDATE 127.0.0.1 " + JSON.stringify(message) + "\r\n");
            signalSocket.send("UPDATE ::1 " + JSON.stringify(message) + "\r\n");
        });

        async function sendOffer() {
            // Send 2, one IPV6 and 1 IPV4
            signalSocket.send("OFFER 127.0.0.1 {}\r\n");
            signalSocket.send("OFFER ::1 {}\r\n");
        }

        var pingInterval = null;
        signalSocket.onopen = function() {
            sendOffer();
            pingInterval = setInterval(ping, 10000);
            offerTimeout = setInterval(sendOffer, 5000);
        }

        signalSocket.onclose = function() {
            clearInterval(pingInterval)
            pingInterval = null;
        }

        signalSocket.onmessage = async function(m) {
            let splitData = m.data.replace('\r\n', '').split(' ')
            let cmd = splitData.shift();
            let ip = splitData.shift();
            let data = splitData.join(' ');

            if (cmd == 'ANSWER')
                clearInterval(offerTimeout);
            else if (cmd == 'UPDATE')
                app.ports.receiveGameState.send(JSON.parse(data));
        }

        function ping() {
            if (pingInterval != null)
                signalSocket.send("PING\r\n");
        }
    </script>
</body>
</html>