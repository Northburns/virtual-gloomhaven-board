<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gloomhaven Board Helper</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.min.js"></script>
</head>
<body>
    <div id="elm-node"></div>
    <script>
        document.body.addEventListener("dragstart", event => {
            if (event.target && event.target.draggable) {
                // absurdly, this is needed for Firefox; see https://medium.com/elm-shorts/elm-drag-and-drop-game-630205556d2
                event.dataTransfer.setData("text/html", "blank");
            }
        });

        document.body.addEventListener("dragover", event => {
            // this is needed in order to make dragging work
            return false;
        });

        const app = Elm.Main.init({
            node: document.getElementById("elm-node"),
            flags: Math.floor(Math.random() * Math.floor(4000))
        });

        /** NOTE THIS IS A SERVER (Remote) IMPLEMENTATION **/

        // For each offer, add the IP to a list of users and distribute

        const signalSocket = new WebSocket('ws://localhost:5000/ws');
        let arrClients = [];

        app.ports.pushGameStatePort.subscribe(function(message) {
            updateClients(message);
        });

        var pingInterval = null;
        signalSocket.onopen = function() {
            pingInterval = setInterval(ping, 10000);
        }

        signalSocket.onclose = function() {
            clearInterval(pingInterval)
            pingInterval = null;
        }

        signalSocket.onmessage = async function(m) {
            let splitData = m.data.replace('\r\n', '').split(' ')
            let cmd = splitData.shift();
            let ip = splitData.shift();
            let data = splitData.join(' ');

            if (cmd == 'OFFER') {
                signalSocket.send('ANSWER ' + ip + " {}\r\n");
                arrClients.push(ip);
            } else if (cmd == 'UPDATE') {
                let message = JSON.parse(data);
                app.ports.receiveGameState.send(message);
                updateClients(message)
            }
        }

        function ping() {
            if (pingInterval != null)
                signalSocket.send("PING\r\n");
        }

        function updateClients(message) {
            for (let i = 0; i < arrClients.length; i++)
                signalSocket.send("UPDATE " + arrClients[i] + " " + JSON.stringify(message) + "\r\n");
        }
    </script>
</body>
</html>